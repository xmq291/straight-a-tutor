$(function(){function t(){i();r()}function i(){n.on("keyup",".password-input",function(){var n=$(this).val();[{selector:".letter-check",regex:/[a-zA-Z]/g},{selector:".number-check",regex:/\d+/g},{selector:".length-check",regex:/^[ A-Za-z0-9-!$%^&*()_+|~=`{}@#\\\[\]:";'<>?,.\/]{6,}$/},].forEach(function(t){var i=$(t.selector);n.match(t.regex)?i.addClass("password-match"):i.removeClass("password-match")})})}function r(){n.on("click",".show-password",function(){var n=$(this),t=n.parent().next(".password-input"),i=t.attr("type").toLowerCase();i==="password"?(n.html("Hide"),t.prop("type","text")):(n.html("Reveal"),t.prop("type","password"))})}var n=$(document);t()});window.wyzant=window.wyzant||{};window.wyzant.wyzantSSO=function(){var r=$(document),pt=$(".sso-start-login"),wt=$(".sso-start-signup"),f=null,w=null,b=!1,c=!0,k=!1,y=null,o=!0,s="sso-current-page",d="ajax-loading",g="ui-overlay",bt="wyz-loader wyz-loader-multi wyz-loader-large",i={},u={login:"login",signup:"signup",link:"link"},kt=function(){var n=window.location.pathname.toLowerCase();c=n.indexOf("/login")!=0&&n.indexOf("/signup")!=0;$.fn.validate?nt():$.getScript("/dist/bundles/js/validation.js",function(){nt()});setTimeout(function(){tt()},1e3)},nt=function(){if(!k){if(c){pt.on("click",function(n){n.preventDefault();ut(!0)});wt.on("click",function(n){n.preventDefault();rt(!0)});r.on("click","#sso-modal-container .wyzModal-close",function(n){n.preventDefault();v()});r.on("click","#sso-modal-blackout, #sso-modal-container",function(n){n.target===n.currentTarget&&v()})}r.on("submit",".sso-page-wrapper form",function(n){n.preventDefault()});r.on("click","[data-sso-show-page]",function(t){t.preventDefault();var i=$(this).attr("data-sso-show-page");if(i)n(i);else return!0});r.on("submit",".sso-signup-form",function(n){n.preventDefault();dt($(this))});r.on("submit",".sso-login-form",function(n){n.preventDefault();gt($(this))});r.on("click",".btn-facebook-signup",function(n){n.preventDefault();var t=$(this).attr("formaction")||"#";st(u.signup,t)});r.on("click",".btn-facebook-login",function(n){n.preventDefault();var t=$(this).attr("formaction")||"#";st(u.login,t)});r.on("submit",".sso-missing-zip-form",function(n){n.preventDefault();var r=$(this),f=r.attr("action")||"#",u=r.find("#ZipCode").val();i.provider&&i.token&&u?ht(f,i.provider,i.token,u):(e(r,{GenericLinkError:["Login failed, please try again.",]}),t("Error completing a social signup with a missing zip.",{socialAuthData:i,zipCode:u}))});r.on("submit",".sso-link-account-form",function(n){n.preventDefault();ti($(this))});k=!0}},tt=function(){window.wyzant.logging&&window.wyzant.logging.eLogger&&window.wyzant.logging.eLogger.logEvent&&(b=!0)},it=function(){var n=$.Deferred();return y?!0:($.ajax({url:"/sso",type:"get",cache:!0}).done(function(i,r,u){u.status===200?(y=i,n.resolve(!0)):(n.reject(null),t("Error loading the SSO pages.",{data:i,textStatus:r}))}).fail(function(i,r,u){n.reject(null);t("Error loading the SSO pages.",{textStatus:r,errorThrown:u})}),n.promise())},rt=function(i){o=i;et();$.when(it()).then(function(){ft();n("sso_signup-landing")}).fail(function(){n("sso_error");t("Error starting SSO signup. Was not able to load pages.")})},ut=function(i){o=i;et();$.when(it()).then(function(){ft();n("sso_login-landing")}).fail(function(){n("sso_error");t("Error starting SSO login. Was not able to load pages.")})},ft=function(){yt();c&&f.html(y);w=$(".sso-page-wrapper");ot();$.validator.unobtrusive.parse(w)},et=function(){if(c){v();$("body").append('<div id="sso-modal-blackout" class="wyzModal-blackout"><\/div><div id="sso-modal-container" class="wyzModal-container"><div class="wyzModal-closeContainer"><a class="wyzModal-close" href="#closeModal"><i class="wc-times"><\/i><\/a><\/div><div id="sso-modal" class="wyzModal"><\/div><\/div>');f=$("#sso-modal");vt();setTimeout(function(){$("#sso-modal-blackout, #sso-modal-container").css({opacity:1});window.scrollTo(0,0)},50)}},v=function(){c&&$("#sso-modal-blackout, #sso-modal-container").remove();i={}},l=function(n,i){delete i.password;v();try{var r=document.createEvent("CustomEvent");r.initCustomEvent(n,!0,!0,i);window.dispatchEvent(r)}catch(r){t("Error triggering our custom event.",{error:r})}},ot=function(){window.FB?$(".btn-facebook").removeAttr("disabled"):t("Error enabling social buttons.",{"FB object":window.FB})},n=function(n,i){var r=$("#"+n),u=$("*[id*=sso_signup-landing]").length>1;u?(r=$(".wyzModal #"+n),$(".wyzModal ."+s).removeClass(s).removeClass("sso-current-page-instant")):$("."+s).removeClass(s).removeClass("sso-current-page-instant");n!=="sso_error"||i||(i="");r&&r.length?r.addClass(s):($("#sso_error").addClass(s),t("Error switching to page.",{"requested page":n}))},dt=function(i){var u=i[0].action,r={emailAddress:i.find("#EmailAddress").val(),password:i.find("#Password").val(),firstName:i.find("#FirstName").val(),lastName:i.find("#LastName").val(),zipCode:i.find("#ZipCode").val(),adSourceModel:{adSourceId:i.find("#AdSourceModel_AdSourceID").val(),adSourceDetails:i.find("#AdSourceModel_AdSourceDetails").val()||null}};h({action:u,method:"post",data:JSON.stringify(r)}).done(function(t){if(t.Success)if(lt(),o){var u=t.Model&&t.Model.returnUrl?t.Model.returnUrl:null;a(u)}else t.Model&&(r.username=r.emailAddress,r.accessToken=t.Model.accessToken),l("wyzantSSO.signup",r);else t.ErrorMessages.SignupExistingUser?($(".existing-wyzant-email").text(r.emailAddress),document.body.scrollTop=document.documentElement.scrollTop=0,n("sso_signup-wyzant-account-exists")):e(i,t.ErrorMessages)}).fail(function(i,r,u){n("sso_error");t("Error doing a Wyzant signup.",{textStatus:r,errorThrown:u})})},gt=function(n){var r=n[0].action,i={username:n.find("#Username").val(),password:n.find("#Password").val()};h({action:r,method:"post",data:JSON.stringify(i)}).done(function(t){if(t.Success)if(o){var r=t.Model&&t.Model.returnUrl?t.Model.returnUrl:null;a(r)}else t.Model&&(i.accessToken=t.Model.accessToken),l("wyzantSSO.login",i);else e(n,t.ErrorMessages)}).fail(function(i,r,u){e(n,{GenericLoginError:["Login failed, please try again.",]});t("Error doing a Wyzant login.",{textStatus:r,errorThrown:u})})},st=function(t,i){var r=function(n){t===u.login?ni(i,"facebook",n):ht(i,"facebook",n)};FB.getLoginStatus(function(t){t.status==="connected"?r(t.authResponse.accessToken):FB.login(function(t){if(t.authResponse&&t.authResponse.grantedScopes&&t.authResponse.grantedScopes.indexOf("email")<0){n("sso_error","You must provide your <strong>email address<\/strong> to add a social account.");return}t.status==="connected"&&r(t.authResponse.accessToken)},{scope:"public_profile,email",return_scopes:!0})})},ht=function(r,f,s,c){if(!(r||f||s)){n("sso_error");t("Missing data for a social signup.",{handlerUrl:r,provider:f,socialToken:s});return}c||(c=at());i={provider:f,token:s,postalCode:c};h({action:r,method:"post",data:JSON.stringify(i)}).done(function(n){var t,i;n.Success?(lt(),o?(t=n.Model&&n.Model.returnUrl?n.Model.returnUrl:null,a(t)):(i={username:n.Model.emailAddress,accessToken:n.Model.accessToken},l("wyzantSSO.signup",i))):e($form,n.ErrorMessages)}).fail(function(n){n=JSON.parse(n.responseText);p(n,u.signup)})},ni=function(r,f,s){if(!(r||f||s)){n("sso_error");t("Missing data for a social login.",{handlerUrl:r,provider:f,socialToken:s});return}i={provider:f,token:s};h({action:r,method:"post",data:JSON.stringify(i)}).done(function(n){var t,i;n.Success?o?(t=n.Model&&n.Model.returnUrl?n.Model.returnUrl:null,a(t)):(i={username:n.Model.emailAddress,accessToken:n.Model.accessToken},l("wyzantSSO.login",i)):e($form,n.ErrorMessages)}).fail(function(n){n=JSON.parse(n.responseText);p(n,u.login)})},ti=function(r){if(!(i.provider||i.token))return n("sso_error"),t("Error linking a social account. Missing provider or 3rd party token.",{socialAuthData:i}),!1;var s=r[0].action,f={provider:i.provider,token:i.token,siteUser:r.find("#Username").val(),sitePass:r.find("#Password").val()};h({action:s,method:"post",data:JSON.stringify(f)}).done(function(n){var t,i;n.Success?o?(t=n.Model&&n.Model.returnUrl?n.Model.returnUrl:null,a(t)):(i={username:f.siteUser,accessToken:n.Model.accessToken},l("wyzantSSO.login",i)):e(r,n.ErrorMessages)}).fail(function(n){n=JSON.parse(n.responseText);p(n,u.link)})},fi=function(n,i){return(n||i)?h({action:"/sso/completesociallinking",method:"post",data:JSON.stringify({emailAddress:n,accessToken:i})}):(t("Missing data for completing social linking.",{emailAddress:n,accessToken:i}),!1)},p=function(r,f){if(r&&r.err)switch(r.err){case"ErrInvalidPostalCode":n("sso_signup-missing-zip");break;case"ErrInvalidData":f===u.link?n("sso_signup-link-social-account"):(n("sso_error"),t("Unhandled invalid data.",{res:r}));break;case"ErrInvalidToken":n("sso_error");t("Invalid token.",{res:r,socialAuthData:i});break;case"ErrAccountExists":ii(r);n("sso_signup-social-account-exists");break;case"ErrTutorConflict":f===u.signup?n("sso_signup-tutor-account-exists"):(ct(r,!0),n("sso_signup-link-social-account"));break;case"ErrStudentConflict":ct(r,!1);n("sso_signup-link-social-account");break;case"ErrUserConflict":n("sso_error");t("Generic user conflict.",{res:r});break;case"ErrUserNotFound":f===u.login?(ri(),n("sso_login-user-not-found")):(n("sso_error"),t("Unhandled user not found.",{res:r}));break;case"ErrUserLinking":n("sso_signup-link-social-account");e($(".sso-link-account-form"),{GenericLinkError:["Login failed, please try again.",]});break;default:n("sso_error");t("Unhandled social error.",{res:r,action:f,socialAuthData:i})}else n("sso_error"),t("Unknown social error.",{res:r,action:f,socialAuthData:i})},ct=function(n,t){var i=n&&n.info&&n.info.email?n.info.email:"",r=$("#sso_signup-link-social-account");r.find(".existing-wyzant-email").text(i);t||r.find("#Username").val(i).prop("disabled",i)},ii=function(n){var t=n&&n.info&&n.info.email?n.info.email:"";$(".existing-social-email").text(t)},ri=function(){var n=at(),t=$("#sso_login-user-not-found");t.find("#ZipCode").val(n)},lt=function(){window.optimizely=window.optimizely||[];window.optimizely.push(["trackEvent","StudentAccountCreated"])},a=function(t){n("sso_redirecting");t?window.location=t:window.location.reload(!0)},at=function(){var n;return window.localStorage&&(n=window.localStorage.getItem("lastZip")||window.localStorage.getItem("lastGeolocatedZip")),n||(n=ui("zip")),n},ui=function(n){var i=new RegExp("(^"+n+"=|;\\s?"+n+"=)([^;]+)"),t=document.cookie.match(i);return t!==null&&t.length===3?t[2]:""},h=function(n){n=n||{};var t=n.action,i=n.method,r=n.data,u=n.dataType!==undefined?n.dataType:"json",f=n.contentType!==undefined?n.contentType:"application/json",e=n.cache!==undefined?n.cache:!0;return vt(),$.ajax({url:t,type:i,data:r,dataType:u,contentType:f,cache:e}).always(function(){yt()})},e=function(n,t){var i,u,f,r,e;for(i in t){for(u=t[i],f=[],r=0,e=u.length;r<e;r++)f.push(u[r]);n.find("[name='"+i+"']").addClass("input-validation-error");n.find("[data-valmsg-for='"+i+"']").attr({"class":"field-validation-error"}).html(f.join("<br>"))}},vt=function(){var n=$(".sso-page-wrapper");f&&f.length&&(n=f);n.addClass(g).append('<div class="'+d+'"><div class="'+bt+'"><div class="cube cube-1"><\/div><div class="cube cube-2"><\/div><div class="cube cube-4"><\/div><div class="cube cube-3"><\/div><\/div><\/div>')},yt=function(){var n=$(".sso-page-wrapper");f&&f.length&&(n=f);n.removeClass(g).find("."+d).remove()},t=function(n,t){if(!b)return tt(),!1;window.wyzant.logging.eLogger.logEvent("SSO_error",n,t)};return{init:kt,startSignup:rt,startLogin:ut,switchToPage:n,enableSocialButtons:ot}}()